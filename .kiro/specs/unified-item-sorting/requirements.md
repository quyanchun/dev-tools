# 需求文档

## 简介

本文档规定了实现统一排序系统的需求，该系统允许监控、文件夹和按钮在单个列表中自由重新排序，而不是仅限于在各自的类型组内排序。

## 术语表

- **项目（Item）**: 泛指三种类型中的任意一种：监控、文件夹或按钮
- **统一列表（Unified_List）**: 包含所有项目的单一有序集合，不考虑类型
- **位置（Position）**: 决定项目在统一列表中显示顺序的整数值
- **项目类型（Item_Type）**: 表示项目是监控、文件夹还是按钮的枚举
- **数据库（Database）**: 存储所有应用程序数据的 SQLite 数据库
- **前端存储（Frontend_Store）**: Zustand 状态管理存储（launcherStore、monitorStore）
- **拖放系统（Drag_Drop_System）**: 基于 react-dnd 的拖放界面，用于重新排序项目

## 需求

### 需求 1：统一数据模型

**用户故事：** 作为开发者，我希望为所有项目类型提供统一的数据模型，以便系统能够高效地管理混合类型排序。

#### 验收标准

1. 数据库应当为所有项目（监控、文件夹、按钮）存储统一的位置字段
2. 当从数据库查询项目时，系统应当返回按位置排序的项目，不考虑项目类型
3. 系统应当在迁移期间保持与现有位置值的向后兼容性
4. 当创建项目时，系统应当为其分配统一列表中的下一个可用位置值

### 需求 2：位置管理

**用户故事：** 作为用户，我希望系统自动管理位置，这样我就不会遇到间隙或冲突的排序问题。

#### 验收标准

1. 当在特定位置插入项目时，系统应当更新所有后续项目的位置
2. 当删除项目时，系统应当重新计算位置以消除间隙
3. 当通过拖放重新排序项目时，系统应当原子性地更新所有受影响的项目位置
4. 系统应当确保在任何时候都没有两个项目具有相同的位置值

### 需求 3：拖放重新排序

**用户故事：** 作为用户，我希望能够将任何项目（监控、文件夹或按钮）拖放到任何位置，以便我可以自由组织我的工作空间。

#### 验收标准

1. 当用户拖动项目时，拖放系统应当允许将其放置在任意两个项目之间，不考虑项目类型
2. 当用户将项目放置到新位置时，系统应当更新项目的位置并将更改持久化到数据库
3. 当重新排序正在进行时，系统应当提供显示放置目标位置的视觉反馈
4. 当拖动操作被取消时，系统应当恢复原始项目位置

### 需求 4：视觉显示

**用户故事：** 作为用户，我希望在单个统一列表中看到所有项目，以便我可以一目了然地了解完整的排序。

#### 验收标准

1. 前端存储应当提供所有项目的统一排序列表
2. 当渲染主页时，系统应当按位置顺序显示项目，不考虑项目类型
3. 当项目的位置发生变化时，系统应当立即更新显示，无需完全重新加载页面
4. 系统应当在保持统一排序的同时，视觉上区分不同的项目类型

### 需求 5：文件夹包含

**用户故事：** 作为用户，我希望文件夹内的项目与主列表排序保持分离，以便保留文件夹组织。

#### 验收标准

1. 当项目具有 folder_id 时，系统应当将其从主统一列表排序中排除
2. 当显示文件夹内的项目时，系统应当使用项目相对于同一文件夹中其他项目的位置
3. 当将项目移入或移出文件夹时，系统应当重新计算主列表和文件夹内容的位置
4. 系统应当为主列表和每个文件夹维护单独的位置序列

### 需求 6：数据库迁移

**用户故事：** 作为开发者，我希望将现有数据迁移到统一系统，以便用户不会丢失当前的组织结构。

#### 验收标准

1. 系统应当提供迁移脚本，将现有的独立位置值转换为统一位置
2. 当迁移时，系统应当保留相对顺序：监控优先，然后是文件夹，然后是按钮
3. 当迁移完成时，系统应当验证所有项目都具有有效的唯一位置
4. 如果迁移失败，则系统应当回滚更改并报告错误

### 需求 7：API 更新

**用户故事：** 作为开发者，我希望更新后端 API，以便前端可以管理统一的项目排序。

#### 验收标准

1. 系统应当提供 API 端点以检索按位置排序的所有项目
2. 系统应当提供 API 端点以在单个事务中更新多个项目位置
3. 当通过 API 更新位置时，系统应当验证所有位置值都是唯一且连续的
4. 系统应当维护现有的单个项目 CRUD API 以实现向后兼容性

### 需求 8：状态管理

**用户故事：** 作为开发者，我希望统一的状态管理，以便前端可以高效地处理混合类型项目列表。

#### 验收标准

1. 前端存储应当为所有项目及其位置提供单一真实来源
2. 当创建、更新或删除项目时，前端存储应当相应地更新统一列表
3. 前端存储应当公开跨类型重新排序项目的方法
4. 当应用程序加载时，前端存储应当按位置顺序获取并缓存所有项目

### 需求 9：性能

**用户故事：** 作为用户，我希望流畅的拖放性能，以便即使有很多项目，重新排序也能感觉响应迅速。

#### 验收标准

1. 当拖动项目时，系统应当在 16ms 内更新 UI（60fps）
2. 当放置项目时，系统应当在 200ms 内持久化位置更改
3. 系统应当处理多达 1000 个项目的列表而不会出现明显的延迟
4. 系统应当批量更新位置以最小化数据库写入

### 需求 10：错误处理

**用户故事：** 作为用户，我希望在重新排序失败时看到清晰的错误消息，以便我了解出了什么问题。

#### 验收标准

1. 如果位置更新失败，则系统应当显示错误消息并恢复到先前的排序
2. 如果在重新排序期间数据库连接丢失，则系统应当将更改排队并在恢复连接时重试
3. 当检测到位置冲突时，系统应当自动解决它们并记录警告
4. 系统应当在持久化之前验证位置值以防止数据损坏

### 需求 11：代码清理和维护

**用户故事：** 作为开发者，我希望删除不再使用的旧代码，以便代码库保持清洁和可维护。

#### 验收标准

1. 当统一排序系统实施后，系统应当删除或标记为已弃用的旧的独立位置更新函数
2. 系统应当从 API 层删除不再使用的端点
3. 系统应当清理前端组件中的旧类型特定排序逻辑
4. 系统应当更新文档以反映新的统一 API
5. 系统应当保持向后兼容性，直到确认所有依赖项都已更新
