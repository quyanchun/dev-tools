# 实施计划：统一项目排序

## 概述

本实施计划将统一项目排序功能分解为离散的编码任务。该方法遵循自下而上的策略：从数据库和后端更改开始，然后是状态管理，最后是 UI 更新。每个任务都建立在先前的工作之上，以确保具有可测试里程碑的增量进度。

## 任务

- [x] 1. 后端：创建统一项目类型和 API 端点
  - 在 `src-tauri/src/database/models.rs` 中创建 `UnifiedItem` 枚举
  - 为批量更新创建 `UnifiedPositionUpdate` 结构
  - 在 `repository.rs` 中实现 `get_all_items_by_container` 函数，查询所有三个表并返回统一列表
  - 添加 Tauri 命令 `get_all_items`，返回按位置排序的项目
  - 添加 Tauri 命令 `update_unified_positions`，用于支持事务的批量位置更新
  - _需求：1.2、7.1、7.2_

- [x] 1.1 为统一项目查询编写属性测试
  - **属性 1：查询返回按位置排序的项目**
  - **验证：需求 1.2**
  - 生成所有类型的随机项目和随机位置，插入数据库，按容器查询，验证按位置排序
  - _需求：1.2_

- [x] 1.2 为批量位置更新编写属性测试
  - **属性 14：API 验证唯一位置**
  - **验证：需求 7.3**
  - 生成同一容器中具有重复位置的批量更新，验证 API 拒绝并返回错误
  - _需求：7.3_

- [x] 2. 后端：实现位置管理逻辑
  - 实现新项目的位置计算（max + 1）
  - 实现插入的位置移动逻辑
  - 实现删除的间隙消除逻辑
  - 添加容器内位置唯一性验证
  - 添加非负位置验证
  - _需求：1.4、2.1、2.2、2.4、10.4_

- [x] 2.1 为新项目位置分配编写属性测试
  - **属性 2：新项目获得下一个位置**
  - **验证：需求 1.4**
  - 生成随机项目列表，创建新项目，验证位置 = max + 1
  - _需求：1.4_

- [x] 2.2 为插入位置移动编写属性测试
  - **属性 3：插入移动后续项目**
  - **验证：需求 2.1**
  - 生成随机项目列表和插入位置，插入项目，验证所有后续项目递增
  - _需求：2.1_

- [x] 2.3 为删除间隙消除编写属性测试
  - **属性 4：删除消除间隙**
  - **验证：需求 2.2**
  - 生成随机项目列表，删除随机项目，验证剩余位置是连续的 0..n-1
  - _需求：2.2_

- [x] 2.4 为位置唯一性编写属性测试
  - **属性 5：位置始终唯一**
  - **验证：需求 2.4**
  - 生成随机操作（创建/更新/删除），执行操作，验证容器中所有位置唯一
  - _需求：2.4_

- [x] 2.5 为无效位置拒绝编写属性测试
  - **属性 16：拒绝无效位置**
  - **验证：需求 10.4**
  - 生成无效位置值（负数或创建间隙），尝试更新，验证拒绝
  - _需求：10.4_

- [x] 3. 后端：实现迁移脚本
  - 在新文件 `src-tauri/src/database/migration.rs` 中创建迁移函数 `migrate_to_unified_positions`
  - 实现迁移逻辑：分配位置保留顺序（监控、文件夹、按钮）
  - 处理文件夹中具有单独位置序列的项目
  - 添加迁移验证检查（唯一位置、连续、无间隙）
  - 在数据库中添加迁移完成标志
  - 在 `main.rs` 中的应用程序启动时调用迁移
  - _需求：6.1、6.2、6.3、6.4_

- [x] 3.1 为迁移编写单元测试
  - 测试迁移保留相对顺序（监控优先、文件夹第二、按钮第三）
  - 测试迁移分配连续位置
  - 测试迁移处理空表
  - 测试失败时迁移回滚
  - _需求：6.2、6.3、6.4_

- [x] 4. 前端：创建统一存储
  - 使用 `UnifiedItem` 接口创建 `src/store/unifiedStore.ts`
  - 实现 `fetchAllItems` 从后端加载所有项目
  - 实现 `getItemsByContainer` 按 folder_id 过滤项目
  - 实现 `reorderItems` 用于拖放位置更新
  - 实现 `addItem`、`updateItem`、`deleteItem` 用于 CRUD 操作
  - 添加同步函数以更新旧存储（launcherStore、monitorStore）
  - _需求：8.1、8.2、8.4_

- [x] 4.1 为存储排序列表编写属性测试
  - **属性 8：存储提供排序列表**
  - **验证：需求 4.1**
  - 在存储中生成随机项目，调用 getItemsByContainer，验证按位置排序
  - _需求：4.1_

- [x] 4.2 为文件夹项目排除编写属性测试
  - **属性 9：文件夹项目从主列表中排除**
  - **验证：需求 5.1**
  - 生成一些具有 folder_id 的随机项目，调用 getItemsByContainer(null)，验证没有文件夹项目
  - _需求：5.1_

- [x] 4.3 为文件夹项目排序编写属性测试
  - **属性 10：文件夹项目按位置排序**
  - **验证：需求 5.2**
  - 生成具有项目的随机文件夹，调用 getItemsByContainer(folderId)，验证按位置排序
  - _需求：5.2_

- [x] 4.4 为存储更新编写属性测试
  - **属性 15：存储更新反映更改**
  - **验证：需求 8.2**
  - 生成随机项目操作，执行操作，验证存储反映更改
  - _需求：8.2_

- [x] 5. 前端：更新 Tauri API 客户端
  - 向 `src/api/tauri.ts` 添加 `getUnifiedItems` 函数
  - 添加带有 `UnifiedPositionUpdate[]` 参数的 `updateUnifiedPositions` 函数
  - 为 `UnifiedItem` 和 `UnifiedPositionUpdate` 添加 TypeScript 接口
  - 更新现有位置更新函数以在内部使用统一 API
  - _需求：7.1、7.2_

- [x] 6. 前端：更新拖放逻辑
  - 修改 `DragDropWrapper.tsx` 以使用统一存储
  - 删除特定于类型的排序逻辑（监控/文件夹/按钮的单独处理）
  - 实现统一位置计算算法
  - 更新 `handleDragEnd` 以统一计算所有项目类型的新位置
  - 实现放置时的批量位置更新，失败时回滚
  - 为放置目标位置添加视觉反馈
  - _需求：3.1、3.2、3.4、10.1_

- [x] 6.1 为放置持久化编写属性测试
  - **属性 6：放置持久化位置**
  - **验证：需求 3.2**
  - 生成随机项目和放置位置，放置项目，从数据库重新加载，验证在新位置
  - _需求：3.2_

- [x] 6.2 为取消恢复编写属性测试
  - **属性 7：取消恢复位置**
  - **验证：需求 3.4**
  - 生成随机项目列表，开始拖动，取消拖动，验证位置不变
  - _需求：3.4_

- [x] 6.3 为移动时位置重新计算编写属性测试
  - **属性 11：移动项目重新计算位置**
  - **验证：需求 5.3**
  - 生成随机项目和容器，在容器之间移动项目，验证两者都有连续位置
  - _需求：5.3_

- [x] 6.4 为独立位置序列编写属性测试
  - **属性 12：独立位置序列**
  - **验证：需求 5.4**
  - 跨容器生成随机项目，查询所有容器，验证每个容器都有位置 0..n-1
  - _需求：5.4_

- [x] 7. 前端：创建 UnifiedCard 组件
  - 创建 `src/pages/HomePage/components/UnifiedCard.tsx`
  - 实现基于类型的渲染（根据 item.type 切换）
  - 为监控渲染 MonitorCard
  - 为文件夹渲染 FolderCard
  - 为按钮渲染 ButtonCard
  - 使用 useSortable 钩子添加拖放支持
  - _需求：4.2、4.4_

- [x] 8. 前端：更新 HomePage 以使用统一存储
  - 修改 `HomePage.tsx` 以从统一存储获取项目
  - 用统一列表替换监控/文件夹/按钮的单独渲染
  - 使用 UnifiedCard 组件渲染项目
  - 在渲染前按位置对项目排序
  - 更新文件夹内容渲染以使用统一存储
  - _需求：4.1、4.2_

- [ ] 9. 前端：实现错误处理
  - 在统一存储中添加位置冲突检测和解决
  - 实现失败位置更新的回滚逻辑
  - 为失败的重新排序操作添加错误消息
  - 实现连接丢失场景的重试队列
  - 为待处理更新添加用户通知
  - _需求：10.1、10.2、10.3_

- [ ] 9.1 为错误处理编写单元测试
  - 测试失败位置更新时的回滚
  - 测试冲突解决保留创建时间顺序
  - 测试连接丢失的重试队列
  - _需求：10.1、10.2、10.3_

- [x] 10. 检查点 - 验证核心功能
  - 运行所有基于属性的测试和单元测试
  - 手动测试所有项目类型的拖放重新排序
  - 验证迁移适用于现有数据
  - 验证应用程序重启后位置持久化
  - 确保所有测试通过，如有问题请询问用户

- [ ] 11. 集成：将所有内容连接在一起
  - 确保统一存储在应用启动时初始化
  - 确保迁移在任何数据访问之前运行
  - 验证旧存储与统一存储正确同步
  - 测试与现有 CRUD 操作的向后兼容性
  - 为位置更新和冲突添加日志记录
  - _需求：1.1、1.2、1.3、1.4、2.1、2.2、2.3、2.4_

- [ ] 11.1 编写集成测试
  - 测试完整的重新排序工作流程（创建项目、拖放、验证持久化）
  - 测试文件夹移动工作流程（在容器之间移动项目）
  - 测试迁移工作流程（旧数据 → 迁移 → 验证新位置）
  - _需求：1.3、6.2、6.3_

- [x] 12. 清理：删除不再使用的代码和 API
  - [x] 12.1 后端清理
    - 从 `src-tauri/src/database/repository.rs` 中删除 `update_button_positions`、`update_monitor_positions`、`update_folder_positions` 函数
    - 从 Tauri 命令处理程序中删除相应的命令
    - 更新后端文档和注释
    - _需求：11.1、11.2_
  
  - [x] 12.2 前端 API 清理
    - 从 `src/api/tauri.ts` 中删除 `updateButtonPositions`、`updateMonitorPositions`、`updateFolderPositions` 函数
    - 删除 `PositionUpdate` 接口（如果不再使用）
    - 更新 API 文档
    - _需求：11.2、11.4_
  
  - [x] 12.3 前端组件清理
    - 清理 `DragDropWrapper.tsx` 中的旧类型特定排序逻辑
    - 删除不再使用的状态变量和辅助函数
    - 简化拖放处理逻辑
    - 删除未使用的导入
    - _需求：11.3_
  
  - [x] 12.4 存储清理
    - 评估是否可以简化或删除 `launcherStore` 和 `monitorStore` 中的某些功能
    - 如果统一存储完全替代了旧存储，考虑标记旧存储为已弃用
    - 更新存储文档
    - _需求：11.1、11.5_
  
  - [x] 12.5 文档更新
    - 更新 README.md 以反映新的统一排序系统
    - 更新 API 文档
    - 添加迁移指南（如果需要）
    - 删除对已删除函数的引用
    - _需求：11.4_

- [x] 12.6 验证向后兼容性
  - 确保现有的 CRUD 操作仍然有效
  - 验证旧代码路径（如果保留）仍然正常工作
  - 测试从旧版本升级的场景
  - 运行所有现有测试以确保没有破坏性更改
  - _需求：11.5_

- [ ] 13. 最终检查点 - 完整测试和验证
  - 运行完整测试套件（单元 + 属性 + 集成）
  - 对所有拖放场景进行手动测试
  - 使用大型数据集（100+ 项目）进行测试
  - 验证性能满足要求（60fps 流畅拖动）
  - 验证清理后没有破坏现有功能
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 所有任务都是全面实施所必需的
- 每个任务都引用特定需求以实现可追溯性
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 集成测试验证端到端工作流程
- 检查点确保增量验证
